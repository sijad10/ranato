<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<ui:composition template="/m/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pm="http://primefaces.org/mobile">    
    
    <ui:define name="body">        
        <h:form id="buscarForm" >        
            <h:inputHidden id="lat" value="#{oficinaPubController.lat}" />
            <h:inputHidden id="lng" value="#{oficinaPubController.lng}" />
            <h:inputHidden id="medidaPopUp" value="#{oficinaPubController.medidaPopUp}" />
            <p:gmap center="#{oficinaPubController.obtenerMapCenterMovilMap()}" zoom="15" type="ROADMAP" 
                     streetView="false" id="gmap" 
                    onPointClick="handlePointClick(event);"
                    style="width: 100%; text-align: center;vertical-align: top;" widgetVar="gmap" model="#{oficinaPubController.modelMap}" >
            </p:gmap>    
            <div id="bienvenidaContainer" style="height: 110px; width: 100%; border: 1px solid gray;background-color: gray; z-index: 100; bottom: 0; position: absolute; margin: 0px auto; left: 0; background: none repeat scroll 0% 0% white; padding: 5px; display: block; text-align: center;">
                <h:outputText value="Reporta una feria no autorizada" style="font-weight: bold;"/> <br /><br />
                <h:outputText value="Ubica el lugar en el mapa, haz click y REPORTA" /> <br /><br />                    
            </div>
            <div id="reportarContainer" style="width: 100%; border: 1px solid gray;background-color: gray; z-index: 100; bottom: 0; position: absolute; margin: 0px auto; left: 0; background: none repeat scroll 0% 0% white; padding: 5px; display: none;">
                 <h:form prependId="false">
                    <h:panelGrid columns="1" style="width: 100%;">
                        <h:outputText value="Â¿Desea reportar una feria no autorizada aqui?" style="font-weight: bold;font-size: smaller;"/>
                        <h:panelGrid columns="2" style="width: 100%;">
                            <p:commandButton value="Si" oncomplete="enviar()" style="border: 1px solid #1f89ce; color: #fff; background: #2399e5;padding: .6em 1em;" />
                            <p:commandButton value="No" onclick="return cancel()" style="border: 1px solid #1f89ce; color: #fff; background: #2399e5;padding: .6em 1em;" />
                        </h:panelGrid>
                    </h:panelGrid>
                </h:form>
            </div>
        </h:form>

        <p:dialog header="Bienvenido" widgetVar="dlg1" minHeight="40" closable="false" position="center top" style="padding:0px!important; background: white;">
            <h:outputText value="Reporta una feria no autorizada" style="font-weight: bold;"/> <br /><br />
            <h:outputText value="Ubica el lugar en el mapa y REPORTA" /> <br /><br />
            <p:commandButton value="OK" onclick="PF('dlg1').hide();" style="border: 1px solid #1f89ce; color: #fff; background: #2399e5;" />
        </p:dialog>      
            
        <script src="#{oficinaPubController.obtenerKeyGoogle()}" type="text/javascript"></script>
        <script type="text/javascript" src="#{oficinaPubController.obtenerApiGoogle()}"></script>
        <script type="text/javascript">
            //var medidaPopUp = 100;//document.getElementById('buscarForm:medidaPopUp').value;
            document.getElementById("buscarForm:gmap").style.height = ""+(window.innerHeight)+"px";
        </script>
        <script type="text/javascript">
            if (navigator.geolocation) {                
                checkGeolocationByHTML5();
            } else {
                checkGeolocationByLoaderAPI(); // HTML5 not supported! Fall back to Loader API.
            }

            function checkGeolocationByHTML5() {
                navigator.geolocation.getCurrentPosition(function(position) {
                    setMapCenter(position.coords.latitude, position.coords.longitude);
                }, function() {
                    checkGeolocationByLoaderAPI(); // Error! Fall back to Loader API.
                });
            }

            function checkGeolocationByLoaderAPI() {
                if (google.loader.ClientLocation) {
                    setMapCenter(google.loader.ClientLocation.latitude, google.loader.ClientLocation.longitude);
                } else {
                    // Unsupported! Show error/warning?
                }
            }

            function setMapCenter(latitude, longitude) {
                PF('gmap').getMap().setCenter(new google.maps.LatLng(latitude, longitude));
            }
        </script>
        <script type="text/javascript">
            var currentMarker = null;
             
            function handlePointClick(event) {
                document.getElementById('buscarForm:lat').value = event.latLng.lat();
                document.getElementById('buscarForm:lng').value = event.latLng.lng();                    
                //document.getElementById('buscarForm:medidaPopUp').value = 200;
                //document.getElementById('titulo').style.height = '200px';
                //console.log(document.getElementById('titulo').style.height);
                //document.getElementById("buscarForm:gmap").style.height = ""+(window.innerHeight - document.getElementById('titulo').style.height.substring(0,3))+"px";
                if(currentMarker != null){
                    currentMarker.setMap(null);
                    currentMarker = null;
                }
                currentMarker = new google.maps.Marker({
                    position:new google.maps.LatLng(event.latLng.lat(), event.latLng.lng())
                });     

                PF('gmap').addOverlay(currentMarker);
                PF('gmap').getMap().setCenter(new google.maps.LatLng(event.latLng.lat(), event.latLng.lng()));
                //document.getElementById('reportar').style.display = 'block';
                document.getElementById('reportarContainer').style.display = 'block';
                document.getElementById('bienvenidaContainer').style.display = 'none';
            }
 
            function enviar(){
                var latitud = document.getElementById('buscarForm:lat').value;
                var longitud = document.getElementById('buscarForm:lng').value;
                location.href= 'Reportar.xhtml?latlng='+latitud+','+longitud;
            }
 
            function markerAddComplete() {                
                var title = document.getElementById('title');
                var descripcion = document.getElementById('descripcion');
                
                if(title.value === 'undefined'){
                   title.value = ''; 
                }
                if(descripcion.value === 'undefined'){
                   descripcion.value = ''; 
                }        
                
                if(title.value.trim().length > 0 ){
                    console.log("entro");
                    currentMarker.setTitle(title.value);
                    document.getElementById('title').value = '';
                    document.getElementById('descripcion').value = '';

                    currentMarker = null;
                    PF('dlg').hide();
                }   
                
            }
 
            function cancel() {
                if(currentMarker != null){
                    currentMarker.setMap(null);
                    currentMarker = null; 
                }
                //document.getElementById('titulo').style.height = '100px';
                //document.getElementById("buscarForm:gmap").style.height = ""+(window.innerHeight - document.getElementById('titulo').style.height.substring(0,3))+"px";
                //document.getElementById('reportar').style.display = 'none';
                document.getElementById('reportarContainer').style.display = 'none';
                document.getElementById('bienvenidaContainer').style.display = 'block';
                return false;
            }
        </script>
         
    </ui:define>
</ui:composition>

